# Development Dockerfile for Dify Web (Next.js)
# Optimized for hot reload during development

FROM node:22-alpine

# Install system dependencies
RUN apk add --no-cache \
    libc6-compat \
    git \
    curl

# Enable corepack for pnpm
RUN corepack enable && corepack prepare pnpm@10.23.0 --activate

# Set environment variables
ENV NODE_ENV=development \
    NEXT_TELEMETRY_DISABLED=1 \
    WATCHPACK_POLLING=true \
    CHOKIDAR_USEPOLLING=true

WORKDIR /app/web

# Copy package files first for better caching
COPY web/package.json web/pnpm-lock.yaml ./

# Install dependencies
RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
    pnpm install --frozen-lockfile

# Copy entrypoint script
COPY docker/dev/entrypoint.web.dev.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose Next.js dev server port
EXPOSE 3000

ENTRYPOINT ["/entrypoint.sh"]
